/*! win-behat 12-03-2014 */
angular.module("winbehat",["ui.codemirror","ui.bootstrap"]),angular.module("winbehat").controller("directoryTreeController",["$scope","$rootScope","$window","filelistService","editFilelistService","modalService","behatService","codeMirrorService",function(a,b,c,d,e,f,g,h){a.filelist={},a.hasFilelist=!1,a.hasFeatures=!1;var i=require("fs"),j=require("nw.gui"),k="tmp/",l=/[\\\/\:\*\?"<>\|]/g;a.openDirectory=function(b){b.files[0]&&(a.hasFilelist=!1,a.hasFeatures=!1,d.read(b.files[0].path,function(c){var d=0,e=0,i=!1,j=null;if(c){for(d=0,e=c.children.length;e>d;d++)if("features"==c.children[d].name.split("\\").pop()){i=!0;break}i?(a.$apply(function(){a.filelist=c,a.hasFilelist=!0,a.hasFeatures=!0}),h.initBehatHint(c.name+"\\features\\bootstrap")):(j=f.openModal("template/modal/confirm.html",!1,{yesLabel:"はい",noLabel:"いいえ",hideCancel:!0,title:"behat --init 実行確認",message:"直下にfeaturesディレクトリが存在しなければ開くことができません。作成しますか？"}),j.result.then(function(d){"ok"==d.selected&&g.init(c.name,function(c,d,e){return c?void f.openModal("template/modal/error.html",!0,{title:"behat --init エラー",message:e||c.message}):void a.openDirectory(b)})}))}}))},a.clickNode=function(a){var c=null;a.item.isDirectory?a.item.isOpen?a.item.isShow=!a.item.isShow:m(a.item):(c=e.push(a.item.name),c!==!0&&("number"==typeof c?b.$broadcast("selectAlreadyOpenFile",c):f.openModal("template/modal/error.html",!0,{title:"ファイル読み込みエラー",message:c.message})))};var m=function(b){d.read(b.name,function(c){a.$apply(function(){c&&(b.children=c.children),b.isOpen=!0,b.isShow=!0})})};a.getIconClass=function(a){return{"icon-expand-directory":a.item.isDirectory&&a.item.isShow,"icon-contract-directory":a.item.isDirectory&&!a.item.isShow,"icon-file":!a.item.isDirectory,"tree-icon":!0}},a.deleteFile=function(){var c=null;c=f.openModal("template/modal/confirm.html",!1,{yesLabel:"はい",noLabel:"いいえ",hideCancel:!0,title:"ファイル削除確認",message:"ファイルを削除しますか？"}),c.result.then(function(c){"ok"==c.selected&&i.unlink(a.contextTarget.file.name,function(c){if(c)return void f.openModal("template/modal/error.html",!0,{title:"ファイル削除エラー",message:c.message});var d=e.getId(a.contextTarget.file.name);d>=0&&b.$broadcast("deleteAlreadyOpenFile",d),a.contextTarget.parent.children.splice(a.contextTarget.index,1),a.$apply()})})},a.renameFile=function(){var b=null;b=f.openModal("template/modal/input.html",!1,{title:"ファイル名変更",label:"ファイル名",inputValue:a.contextTarget.file.name.split("\\").pop()}),b.result.then(function(b){var c="",d="";if("ok"==b.selected&&b.params.inputValue){if(l.test(b.params.inputValue))return void f.openModal("template/modal/error.html",!0,{title:"ファイル名変更エラー",message:'ファイル名に /:*?"<>| は使用できません'});if(c=a.contextTarget.file.name,d=a.contextTarget.file.name.split("\\"),d.pop(),d.push(b.params.inputValue),d=d.join("\\"),i.existsSync(d))return void f.openModal("template/modal/error.html",!0,{title:"ファイル名変更エラー",message:"すでに存在するファイル名です"});i.rename(c,d,function(b){if(b)return void f.openModal("template/modal/error.html",!0,{title:"ファイル名変更エラー",message:b.message});var g=e.getId(c);g>=0&&e.rename(g,d),a.contextTarget.file.name=d,a.$apply()})}})},a.createFile=function(){var b=null;b=f.openModal("template/modal/input.html",!1,{title:"新規ファイル作成",label:"ファイル名"}),b.result.then(function(b){var c=a.contextTarget.file,e=c.name;return"ok"==b.selected&&b.params.inputValue&&l.test(b.params.inputValue)?void f.openModal("template/modal/error.html",!0,{title:"新規ファイル作成エラー",message:'ファイル名に /:*?"<>| は使用できません'}):(e+="\\"+b.params.inputValue,void i.open(e,"wx","0777",function(b,g){return b?void f.openModal("template/modal/error.html",!0,{title:"新規ファイル作成エラー",message:"EEXIST"==b.code?"すでにファイルが存在します":b.message}):void i.write(g,new Buffer(""),0,Buffer.byteLength(""),function(b){if(i.close(g),b)return void f.openModal("template/modal/error.html",!0,{title:"新規ファイル作成エラー",message:b.message});var h=d.file(e);c.isOpen?(c.children.push(h),c.children=c.children.sort(d.sortFunc),c.isShow=!0,a.$apply()):m(c)})}))})},a.createDirectory=function(){var b=null;b=f.openModal("template/modal/input.html",!1,{title:"新規ディレクトリ作成",label:"ディレクトリ名"}),b.result.then(function(b){var c=a.contextTarget.file,e=c.name;return"ok"==b.selected&&b.params.inputValue&&l.test(b.params.inputValue)?void f.openModal("template/modal/error.html",!0,{title:"新規ディレクトリ作成エラー",message:'ディレクトリ名に /:*?"<>| は使用できません'}):(e+="\\"+b.params.inputValue,void i.mkdir(e,function(b){if(b)return void f.openModal("template/modal/error.html",!0,{title:"新規ディレクトリ作成エラー",message:"EEXIST"==b.code?"すでに同名のディレクトリが存在します":b.message});var g=d.file(e);g.isDirectory=!0,g.children=[],c.isOpen?(c.children.push(g),c.children=c.children.sort(d.sortFunc),c.isShow=!0,a.$apply()):m(c)}))})};var n=function(b){a.hasFeatures&&g.run(a.filelist.name,"-f html",b,function(d,e,g){var h="";if(d){if(!e)return void f.openModal("template/modal/error.html",!0,{title:"behat実行エラー",message:g||d.message});if(e.indexOf("<!DOCTYPE html"))return void p("<pre>"+e+"</pre>")}h=k+(a.filelist.name+b+".html").replace(l,"");var m=function(){i.unlink("build/"+h,function(){}),p(e)};i.open("build/"+h,"w","0777",function(a,b){return a?void m():void i.write(b,new Buffer(e),0,Buffer.byteLength(e),function(a){var d=null;return i.close(b),a?void m():(d=j.Window.get(c.open(h)),void d.on("closed",function(){d=null,i.unlink("build/"+h,function(){})}))})})})};a.runBehat=function(){n(a.contextTarget.file.name)},a.$on("runBehat",function(a,b){b=b||"",n(b)});var o=function(b){a.hasFeatures&&g.run(a.filelist.name,"-f snippets",b,function(a,b,c){return a&&!b?void f.openModal("template/modal/error.html",!0,{title:"behat実行エラー",message:c||a.message}):void(b.replace(/[\n|\r]/g,"")?p("<pre>"+b+"</pre>"):f.openModal("template/modal/error.html",!0,{title:"ステップ表示エラー",message:"未定義のステップはありませんでした"}))})};a.showSnippets=function(){o(a.contextTarget.file.name)},a.$on("showSnippets",function(a,b){b=b||"",o(b)});var p=function(a){var b=c.open("","_blank");$(b.document.body).html(a)};a.refreshFolder=function(){var b=a.contextTarget.parent,c=a.contextTarget.index,e=a.contextTarget.file;e.isDirectory&&e.isOpen&&d.read(e.name,function(d){d?b.children[c]=d:b.children.splice(c,1),a.$apply()})}}]),angular.module("winbehat").controller("menuController",["$scope","$rootScope",function(a,b){var c={FILE:"ファイル",BEHAT:"behat"},d={OPEN_PROJECT:"プロジェクトを開く",RUN:"実行",SNIPPETS:"未定義のステップを表示"};a.menuItems=[{label:c.FILE,items:[{label:d.OPEN_PROJECT}]},{label:c.BEHAT,items:[{label:d.RUN},{label:d.SNIPPETS}]}],a.clickItem=function(a,e){if(a==c.FILE)switch(e){case d.OPEN_PROJECT:setTimeout(function(){document.querySelector("#dir-dialog").click()},0)}if(a==c.BEHAT)switch(e){case d.RUN:b.$broadcast("runBehat");break;case d.SNIPPETS:b.$broadcast("showSnippets")}}}]),angular.module("winbehat").controller("textEditorController",["$scope","codeMirrorService","editFilelistService","modalService",function(a,b,c,d){a.editFilelist=c.list,a.editFileCount=0,a.editFile={},a.codeMirror={},a.editorOptions={theme:"mbo",lineNumbers:!0,indentUnit:4,indentWithTabs:!1,matchBrackets:!0,autoCloseBrackets:!0,autoCloseTags:!0,styleSelectedText:!0,styleActiveLine:!0,continueComments:!0,mode:null,extraKeys:{"Ctrl-/":"toggleComment",Tab:b.insertTab,"Ctrl-Space":b.autocomplete,"Ctrl-S":function(){e()}},onLoad:function(b){a.codeMirror=b}},a.$watchCollection("editFilelist",function(b){var c=b.length;c>a.editFileCount&&(a.select(c-1),a.codeMirror.doc.setValue(a.editFile.text),a.editFile.lastText=a.codeMirror.doc.getValue()),a.editFileCount=c}),a.isBold=function(b){return{bold:a.editFile==b?b.lastText!=a.codeMirror.getValue():b.isChanged()}},a.select=function(b){var d=a.editFile,e=c.select(b)||{text:""},f=null;d.path!=e.path&&(window.dispatchEvent(new Event("changeTab")),a.editFile=e,a.codeMirror.setOption("mode",e.mode||""),e.mode&&CodeMirror.autoLoadMode(a.codeMirror,e.mode),a.codeMirror.setOption("indentUnit","gherkin"==e.mode?2:4),d.text=a.codeMirror.getValue(),d.path&&(d.history=a.codeMirror.getHistory()),a.codeMirror.clearHistory(),a.editFile.history&&a.codeMirror.setHistory(a.editFile.history),f=a.$watch("codeMirror.doc.history",function(){a.codeMirror.doc.history.done.pop(),f()}))},a.$on("selectAlreadyOpenFile",function(b,c){a.select(c)}),a.$on("deleteAlreadyOpenFile",function(b,c){a.editFilelist[c].lastText=a.editFilelist[c].text,a.close(c),a.$apply()}),a.close=function(b){var f=null,g=a.editFilelist[b]==a.editFile?a.codeMirror.getValue():a.editFilelist[b].text,h=function(){var d=c.remove(b);d.path==a.editFile.path&&a.select(b-1)};g!=a.editFilelist[b].lastText?(f=d.openModal("template/modal/confirm.html",!1,{yesLabel:"保存して閉じる",noLabel:"保存せずに閉じる",cancelLabel:"キャンセル",title:"保存の確認",message:"ファイルは変更されています。保存しますか？"}),f.result.then(function(b){"ok"==b.selected?e(function(b){return b?void d.openModal("template/modal/error.html",!0,{title:"ファイル保存エラー",message:"ファイルの保存に失敗しました。"}):(h(),void a.$apply())}):"no"==b.selected&&h()})):h()};var e=function(b){a.editFile.path&&a.editFile.lastText!=a.codeMirror.getValue()&&(a.editFile.text=a.codeMirror.getValue(),b=b||function(b){return b?void d.openModal("template/modal/error.html",!0,{title:"ファイル保存エラー",message:"ファイルの保存に失敗しました。"}):void a.$apply()},a.editFile.save(b))}}]),angular.module("winbehat").directive("context",function(){var a=[],b=function(){for(var b in a)a[b].css({display:"none"})};return{restrict:"A",scope:"@&",compile:function(){return{post:function(c,d,e){var f=$("#"+e.context),g=null;f.css({display:"none"}),a[e.context]=f,$(d).on("contextmenu",function(a){b(),c.file&&(angular.element($("#directory-tree")).scope().contextTarget={parent:c.file,index:c.$index,file:c.file.children[c.$index]},f.css({position:"fixed",display:"block",left:a.clientX+"px",top:a.clientY+"px"}),g=a.timeStamp,a.stopPropagation())}),$(document).on("click contextmenu",function(a){var b=$(a.target);if(!b.is(".popover")&&!b.parents().is(".popover")){if(g===a.timeStamp)return;f.css({display:"none"})}})}}}}}),angular.module("winbehat").directive("dirctoryTreeNode",["$compile",function(a){return{restrict:"E",replace:!0,scope:{file:"="},templateUrl:"template/directory-tree-node.html",controller:"directoryTreeController",compile:function(b){var c,d=b.contents().remove();return function(b,e){c||(c=a(d)),c(b,function(a){e.append(a)})}}}}]),angular.module("winbehat").directive("resizeWindow",["$window",function(a){return function(b){var c=document.querySelector("#editor-tabs");b.windowHeight=0,b.windowWidth=0,b.editorHeight=0,b.menuHeight=0,b.initializeWindowSize=function(){b.windowHeight=a.innerHeight,b.windowWidth=a.innerWidth,b.editorHeight=a.innerHeight-c.clientHeight-28,b.menuHeight=a.innerHeight-28},b.initializeWindowSize(),b.$watchCollection("editFilelist",function(){b.initializeWindowSize()}),angular.element(a).bind("resize",function(){return b.initializeWindowSize(),b.$apply()}),angular.element(a).bind("changeTab",function(){b.initializeWindowSize()})}}]),angular.module("winbehat").factory("behatService",function(){return require("./js/my-modules/behat")}),angular.module("winbehat").factory("codeMirrorService",function(){function a(a,c){for(var d=c&&c.word||k,e=a.getCursor(),f=a.getLine(e.line),g=e.ch,h=g;h<f.length&&d.test(f.charAt(h));)++h;for(;g&&d.test(f.charAt(g-1));)--g;for(var i=g!=h&&f.slice(g,h),j=[],l=b(),m=0,n=l.length;n>m;m++)i&&0!=l[m].lastIndexOf(i,0)||j.push(l[m]);return{list:j,from:CodeMirror.Pos(e.line,g),to:CodeMirror.Pos(e.line,h)}}function b(){var a=[];for(var b in j)Array.prototype.push.apply(a,j[b]);return a.sort(function(a,b){return a>b?1:-1})}function c(a){return e.existsSync(a)?e.statSync(a).isDirectory()?void e.readdir(a,function(b,d){if(!b&&d.length)for(var e=0,g=d.length;g>e;e++)c(f.join(a,d[e]))}):void(/.*(Context\.php)$/.test(a)&&e.readFile(a,function(b,c){var d=c.toString().match(/@Give.*\/\^(.*)\$\//g);j[a]=d?d.map(function(a){return a.replace(/@Give.*\/\^(.*)\$\//,"$1")}):[]})):void 0}var d=require("./js/my-modules/filename-extension-list"),e=require("fs"),f=require("path"),g=function(a){var b=a.getOption("indentUnit"),c="",d=a.doc.sel,e=d.from,f=d.to,g=0,h=0,i=[],j={line:0,ch:0},k={line:0,ch:0};if(a.somethingSelected()){for(c=Array(b+1).join(" "),j.line=e.line,g=e.line,h=g+a.getSelection().split("\n").length-!f.ch;h>g;g++)i.push(c+a.doc.getLine(g)),k.line=g,k.ch=a.doc.getLine(g).length;a.doc.replaceRange(i.join("\n"),j,k),j.ch=e.ch+b,k.ch=f.ch+b,a.doc.setSelection(j,k)}else c=Array(b-e.ch%b+1).join(" "),a.replaceSelection(c,"end","+input")},h=function(a){CodeMirror.showHint(a,a.getHelper(a.getCursor(),"hint")||CodeMirror.hint.anyword)};CodeMirror.modeURL="js/lib/codemirror/mode/%N/%N.js";var i=function(a,b){CodeMirror.autoLoadMode(a,d[b]),a.setOption("mode",d[b])},j={};CodeMirror.gherkinHint=a,CodeMirror.registerHelper("hint","gherkin",a);var k=/[^\x01-\x7E]|[\w$]+/,l=null,m=function(a){j={},null!=l&&clearTimeout(l);var b=function(){c(a),l=setTimeout(b,3e4)};b()};return{insertTab:g,autocomplete:h,changeMode:i,initBehatHint:m}}),angular.module("winbehat").factory("editFilelistService",function(){var a=require("fs"),b=require("path"),c=require("./js/my-modules/filename-extension-list"),d=[],e=function(e){for(var f="",g=0,h=d.length;h>g;g++)if(d[g].path===e)return g;return a.existsSync(e)?(f=a.readFileSync(e,{encoding:"utf8"}),d.push({path:e,name:e.split("\\").pop(),isSelected:!1,text:f,lastText:"",history:null,mode:c[b.extname(e).split(".").pop()],save:function(b){return null==this.text?void(b&&b(new Error("text undefined"))):void a.open(this.path,"w","0777",function(c,d){if(c)return void b(c);var e=this.text;e.split("\n").length<=1&&(e+="\n"),a.write(d,new Buffer(e),0,Buffer.byteLength(e),function(c){return c?void b(c):(a.close(d),this.lastText=this.text,void b())}.bind(this))}.bind(this))},isChanged:function(){return this.text!=this.lastText}}),!0):new Error(e+" not found.")},f=function(a){return d.splice(a,1)[0]},g=function(a){var b=0,c=d.length;for(0>a?a=0:a>=c&&(a=c-1);c>b;b++)d[b].isSelected=!1;return d[a]&&(d[a].isSelected=!0),d[a]},h=function(a,b){d[a].path=b,d[a].name=b.split("\\").pop()},i=function(a){var b=0,c=0;for(b=0,c=d.length;c>b;b++)if(d[b].path==a)return b;return-1};return{list:d,push:e,remove:f,select:g,rename:h,getId:i}}),angular.module("winbehat").factory("filelistService",function(){return require("./js/my-modules/filelist")}),angular.module("winbehat").factory("modalService",["$modal",function(a){var b=function(b,c,d){return a.open({templateUrl:b,controller:function(a,b,c){a.params=c||{},a.init&&a.init(a),a.ok=c.ok||function(){b.close(c)},a.yes=c.yes||function(){b.close({selected:"ok",params:c})},a.no=c.no||function(){b.close({selected:"no",params:c})},a.cancel=c.cancel||function(){b.dismiss("cancel")}},backdrop:c||!1,resolve:{params:function(){return d}}})};return{openModal:b}}]);