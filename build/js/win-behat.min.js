/*! win-behat 05-07-2014 */
process._events.uncaughtException.length>0&&process._events.uncaughtException.splice(0,1),process.on("uncaughtException",function(a){console.group("Exception"),a.message&&console.log(a.message),a.stack&&console.log(a.stack),console.log(a),console.groupEnd()}),process._events.uncaughtException.length>1&&process._events.uncaughtException[0].toString().match(/native code/)&&process._events.uncaughtException.splice(0,1),angular.module("winbehat",["ui.codemirror","ui.bootstrap"]),angular.module("winbehat").controller("directoryTreeController",["$scope","$rootScope","$window","filelistService","editFilelistService","modalService","behatService","codeMirrorService","highlighService",function(a,b,c,d,e,f,g,h,i){a.filelist={},a.hasFilelist=!1,a.hasFeatures=!1,a.lastDirectory=c.localStorage.getItem("lastDirectory")||"",a.copyTarget=null;var j=require("path"),k=require("child_process").exec;a.openDirectory=function(b){b.files[0]&&(a.hasFilelist=!1,a.hasFeatures=!1,d.read(b.files[0].path,null,function(d){var e=0,i=0,k=!1,l=null;if(d){for(e=0,i=d.children.length;i>e;e++)if("features"==d.children[e].name){k=!0;break}k?(a.$apply(function(){a.filelist=d,a.hasFilelist=!0,a.hasFeatures=!0}),a.lastDirectory=b.files[0].path,c.localStorage.setItem("lastDirectory",b.files[0].path),h.initBehatHint(j.join(d.path(),"features\\bootstrap"))):(l=f.openModal("template/modal/confirm.html",!1,{yesLabel:"はい",noLabel:"いいえ",hideCancel:!0,title:"behat --init 実行確認",message:"直下にfeaturesディレクトリが存在しなければ開くことができません。作成しますか？"}),l.result.then(function(c){"ok"==c.selected&&g.init(d.path(),function(c,d,e){return c?void f.openModal("template/modal/error.html",!0,{title:"behat --init エラー",message:e||c.message}):void a.openDirectory(b)})}))}}))},a.clickNode=function(a,c){var d=null,g=!1;i.highlight(a.item.path());try{g=a.item.isDirectory()}catch(h){return void a.item.parent.children.splice(c,1)}g?a.item.isOpen?a.item.isShow=!a.item.isShow:l(a.item):(d=e.push(a.item),d!==!0&&("number"==typeof d?b.$broadcast("selectAlreadyOpenFile",d):f.openModal("template/modal/error.html",!0,{title:"ファイル読み込みエラー",message:d.message})))};var l=function(b){d.read(b.path(),null,function(c){a.$apply(function(){c&&(b.children=c.children),b.isOpen=!0,b.isShow=!0})})};a.getIconClass=function(a){return{"icon-expand-directory":a.item.isDirectory()&&a.item.isShow,"icon-contract-directory":a.item.isDirectory()&&!a.item.isShow,"icon-file":!a.item.isDirectory(),"tree-icon":!0}},a.deleteFile=function(){var c=null;c=f.openModal("template/modal/confirm.html",!1,{yesLabel:"はい",noLabel:"いいえ",hideCancel:!0,title:"ファイル削除確認",message:"ファイルを削除しますか？"}),c.result.then(function(c){"ok"==c.selected&&a.contextTarget.file.delete(function(c){if(c)return void f.openModal("template/modal/error.html",!0,{title:"ファイル削除エラー",message:c.message});var d=e.getId(a.contextTarget.file.path());d>=0&&b.$broadcast("deleteAlreadyOpenFile",d),a.$apply()})})},a.deleteDirectory=function(){var b=null;b=f.openModal("template/modal/confirm.html",!1,{yesLabel:"はい",noLabel:"いいえ",hideCancel:!0,title:"ディレクトリ削除確認",message:"ディレクトリを削除しますか？"}),b.result.then(function(b){"ok"==b.selected&&a.contextTarget.file.delete(function(b){return b?void f.openModal("template/modal/error.html",!0,{title:"ディレクトリ削除エラー",message:b.message}):void a.$apply()})})},a.renameFile=function(){var b=null;b=f.openModal("template/modal/input.html",!1,{title:"ファイル名変更",label:"ファイル名",inputValue:a.contextTarget.file.name}),b.result.then(function(b){"ok"==b.selected&&b.params.inputValue&&a.contextTarget.file.rename(b.params.inputValue,function(b){return b?void f.openModal("template/modal/error.html",!0,{title:"ファイル名変更エラー",message:"string"==typeof b?b:b.message}):void a.$apply()})})},a.createFile=function(){var b=null;b=f.openModal("template/modal/input.html",!1,{title:"新規ファイル作成",label:"ファイル名"}),b.result.then(function(b){"ok"==b.selected&&b.params.inputValue&&a.contextTarget.file.createChildFile(b.params.inputValue,"",function(b){b&&f.openModal("template/modal/error.html",!0,{title:"新規ファイル作成エラー",message:b.message}),a.contextTarget.file.sortChildren(),a.$apply()})})},a.createDirectory=function(){var b=null;b=f.openModal("template/modal/input.html",!1,{title:"新規ディレクトリ作成",label:"ディレクトリ名"}),b.result.then(function(b){"ok"==b.selected&&b.params.inputValue&&a.contextTarget.file.createChildDirectory(b.params.inputValue,function(b){return b?void f.openModal("template/modal/error.html",!0,{title:"新規ディレクトリ作成エラー",message:b.message}):(a.contextTarget.file.sortChildren(),void a.$apply())})})};var m=function(b,c){a.hasFeatures&&g.showHtmlResults(a.filelist.name,b,c)};a.runBehat=function(b){m(a.contextTarget.file.path(),b)},a.$on("runBehat",function(a,b){var c=b&&b.features||"",d=b&&b.options||"";m(c,d)});var n=function(b){a.hasFeatures&&g.showSnippets(a.filelist.name,b)};a.showSnippets=function(){n(a.contextTarget.file.path())},a.$on("showSnippets",function(a,b){b=b||"",n(b)}),a.refreshDirectory=function(){var b=a.contextTarget.parent,c=a.contextTarget.index,e=a.contextTarget.file;e.isDirectory()&&e.isOpen&&d.read(e.path(),null,function(d){d?e.children=d.children:b.children.splice(c,1),a.$apply()})},a.copy=function(){a.copyTarget=a.contextTarget.file},a.paste=function(){if(a.copyTarget){var b=null,c=a.contextTarget.file,d=j.join(c.path(),j.basename(a.copyTarget.name)),e=null;d!=a.copyTarget.path()&&(e=function(b){return b?void f.openModal("template/modal/error.html",!0,{title:"貼り付けエラー",message:b.message}):void a.refreshDirectory()},j.existsSync(d)?(b=f.openModal("template/modal/confirm.html",!1,{yesLabel:"はい",noLabel:"キャンセル",hideCancel:!0,title:"上書き確認",message:"同名のファイルが存在します。上書きしますか？"}),b.result.then(function(b){"ok"==b.selected&&c.copyFrom(a.copyTarget.path(),e)})):c.copyFrom(a.copyTarget.path(),e))}},a.explorer=function(){k("explorer "+a.contextTarget.file.path())}}]),angular.module("winbehat").controller("menuController",["$scope","$rootScope","modalService",function(a,b,c){var d={FILE:"ファイル",BEHAT:"behat",HELP:"ヘルプ"},e={OPEN_PROJECT:"プロジェクトを開く",RUN:"実行",STOP_ON_FAILURE:"behat実行(エラー時中止)",SNIPPETS:"未定義のスニペットを表示",SHORTCUT:"ショートカット確認"};a.menuItems=[{label:d.FILE,items:[{label:e.OPEN_PROJECT}]},{label:d.BEHAT,items:[{label:e.RUN},{label:e.STOP_ON_FAILURE},{label:e.SNIPPETS}]},{label:d.HELP,items:[{label:e.SHORTCUT}]}],a.clickItem=function(a,f){if(a==d.FILE)switch(f){case e.OPEN_PROJECT:setTimeout(function(){document.querySelector("#dir-dialog").click()},0)}if(a==d.BEHAT)switch(f){case e.RUN:b.$broadcast("runBehat");break;case e.SNIPPETS:b.$broadcast("showSnippets");break;case e.STOP_ON_FAILURE:b.$broadcast("runBehat",{features:"",options:["--stop-on-failure"]})}if(a==d.HELP)switch(f){case e.SHORTCUT:c.openModal("template/modal/shortcut.html",!0,{title:"ショートカット一覧"})}}}]),angular.module("winbehat").controller("textEditorController",["$scope","$window","codeMirrorService","editFilelistService","modalService","behatService","highlighService",function(a,b,c,d,e,f,g){a.editFilelist=d.list,a.editFileCount=0,a.editFile={},a.codeMirror={},a.editorOptions={theme:"mbo",lineNumbers:!0,indentUnit:4,indentWithTabs:!1,matchBrackets:!0,autoCloseBrackets:!0,autoCloseTags:!0,styleSelectedText:!0,styleActiveLine:!0,continueComments:!0,mode:null,extraKeys:{"Ctrl-/":"toggleComment",Tab:c.insertTab,"Ctrl-Space":c.autocomplete,"Ctrl-S":function(){h()},"Ctrl-B":function(){i()},"Alt-B":function(){i(["--stop-on-failure"])},"Shift-Ctrl-B":function(){j()},"Ctrl-W":function(){a.editFile.file&&(a.close(d.getId(a.editFile.file.path())),a.$apply())},"Shift-Ctrl-W":function(){a.closeAll()},"Ctrl-Tab":function(){l(),a.$apply()},"Shift-Ctrl-Tab":function(){k(),a.$apply()}},onLoad:function(b){a.codeMirror=b,b.on("focus",function(){a.editFile.file&&a.editFile.file.path&&a.editFile.file.path()&&g.highlight(a.editFile.file.path())})}},a.$watchCollection("editFilelist",function(b){var c=b.length;c>a.editFileCount&&(a.select(c-1),a.codeMirror.doc.setValue(a.editFile.text),a.editFile.lastText=a.codeMirror.doc.getValue()),a.editFileCount=c}),a.isBold=function(b){return{bold:a.editFile==b?b.lastText!=a.codeMirror.getValue():b.isChanged()}},a.select=function(b){var c=a.editFile,e=d.select(b)||{text:""},f=null;c.path&&e.path&&c.path()==e.path()||(e.file&&e.file.path&&g.highlight(e.file.path()),window.dispatchEvent(new Event("changeTab")),a.editFile=e,a.codeMirror.setOption("mode",e.mode||""),e.mode&&CodeMirror.autoLoadMode(a.codeMirror,e.mode),a.codeMirror.setOption("indentUnit","gherkin"==e.mode?2:4),c.text=a.codeMirror.getValue(),c.file&&c.file.path()&&(c.history=a.codeMirror.getHistory()),a.codeMirror.clearHistory(),a.editFile.history&&a.codeMirror.setHistory(a.editFile.history),f=a.$watch("codeMirror.doc.history",function(){a.codeMirror.doc.history.done.pop(),f()}),a.codeMirror.focus())},a.$on("selectAlreadyOpenFile",function(b,c){a.select(c)}),a.$on("deleteAlreadyOpenFile",function(b,c){a.editFilelist[c].lastText=a.editFilelist[c].text,a.close(c),a.$apply()}),a.close=function(b){var c=null,f=a.editFilelist[b]==a.editFile?a.codeMirror.getValue():a.editFilelist[b].text,g=function(){var c=d.remove(b);c.file.path()==a.editFile.file.path()&&a.select(b-1)};f!=a.editFilelist[b].lastText?(c=e.openModal("template/modal/confirm.html",!1,{yesLabel:"保存して閉じる",noLabel:"保存せずに閉じる",cancelLabel:"キャンセル",title:"保存の確認",message:a.editFilelist[b].file.name+"は変更されています。保存しますか？"}),c.result.then(function(b){"ok"==b.selected?h(function(b){return b?void e.openModal("template/modal/error.html",!0,{title:"ファイル保存エラー",message:"ファイルの保存に失敗しました。"}):(g(),void a.$apply())}):"no"==b.selected&&g()})):g()},a.closeAll=function(){for(var b=[],c=0,e=0,f=a.editFilelist.length;f>c;c++)b.push(a.editFilelist[c].file.path());for(c=0;f>c;c++)e=d.getId(b[c]),e>=0&&(a.close(e),a.$apply())};var h=function(b){a.editFile.file&&a.editFile.lastText!=a.codeMirror.getValue()&&(a.editFile.text=a.codeMirror.getValue(),b=b||function(b){return b?void e.openModal("template/modal/error.html",!0,{title:"ファイル保存エラー",message:"ファイルの保存に失敗しました。"}):void a.$apply()},a.editFile.save(b))},i=function(b){a.editFile.file.path()&&f.showHtmlResults(a.editFile.file.path().split("features")[0],a.editFile.file.path(),b)},j=function(){a.editFile.file.path()&&f.showSnippets(a.editFile.file.path().split("features")[0],a.editFile.file.path())},k=function(){if(!(a.editFilelist.length<=1)){var b=d.getId(a.editFile.file.path());0>b||(0==b?b=a.editFilelist.length-1:b--,a.select(b))}},l=function(){if(!(a.editFilelist.length<=1)){var b=d.getId(a.editFile.file.path());0>b||(b==a.editFilelist.length-1?b=0:b++,a.select(b))}}}]),angular.module("winbehat").directive("context",["highlighService",function(a){var b=[],c=function(){for(var a in b)b[a].css({display:"none"})};return{restrict:"A",scope:"@&",compile:function(){return{post:function(d,e,f){var g=$("#"+f.context),h=null;g.css({display:"none"}),b[f.context]=g,$(e).on("contextmenu",function(b){a.highlight(d.item.path()),c(),d.file&&(angular.element($("#directory-tree")).scope().contextTarget={parent:d.file,index:d.$index,file:d.file.children[d.$index]},g.css({position:"fixed",display:"block",left:b.clientX+"px",top:b.clientY+"px"}),h=b.timeStamp,b.stopPropagation())}),$(document).on("click contextmenu",function(a){var b=$(a.target);if(!b.is(".popover")&&!b.parents().is(".popover")){if(h===a.timeStamp)return;g.css({display:"none"})}})}}}}}]),angular.module("winbehat").directive("dirctoryTreeNode",["$compile",function(a){return{restrict:"E",replace:!0,scope:{file:"="},templateUrl:"template/directory-tree-node.html",controller:"directoryTreeController",compile:function(b){var c,d=b.contents().remove();return function(b,e){c||(c=a(d)),c(b,function(a){e.append(a)})}}}}]),angular.module("winbehat").directive("pressEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.pressEnter,{event:b})}),b.preventDefault())})}}),angular.module("winbehat").directive("resizable",function(){return{restrict:"A",link:function(a,b){b.resizable({handles:"e",minWidth:20})}}}),angular.module("winbehat").directive("resizeWindow",["$window",function(a){return function(b){var c=document.querySelector("#editor-tabs");b.windowHeight=0,b.windowWidth=0,b.editorHeight=0,b.menuHeight=0,b.editorWidth=0,b.editorLeft=240,b.initializeWindowSize=function(){b.windowHeight=a.innerHeight,b.windowWidth=a.innerWidth,b.editorLeft=$("#directory-tree").width(),b.editorHeight=a.innerHeight-c.clientHeight-28,b.editorWidth=b.windowWidth-b.editorLeft,b.menuHeight=a.innerHeight-28},b.initializeWindowSize(),b.$watchCollection("editFilelist",function(){b.initializeWindowSize()}),angular.element(a).bind("resize",function(){return b.initializeWindowSize(),b.$apply()}),angular.element(a).bind("changeTab",function(){b.initializeWindowSize()})}}]),angular.module("winbehat").factory("behatService",["$window","modalService",function(a,b){var c=require("fs"),d=require("./js/my-modules/behat"),e=require("nw.gui"),f="tmp/",g=/[\\\/\:\*\?"<>\|]/g,h=function(b){var c=a.open("","_blank");$(c.document.body).html(b),i(c)},i=function(a){a.onkeydown=function(a){17==a.keyCode?this.pressCtrl=!0:87==a.keyCode&&(this.pressW=!0),this.pressCtrl&&this.pressW&&this.close()},a.onkeyup=function(a){17==a.keyCode?this.pressCtrl=!1:87==a.keyCode&&(this.pressW=!1)}};return d.saveHtmlResults=function(a,b,e,h){e instanceof Array?e.push("-f html"):e="-f html",d.run(a,e,b,function(d,e,i){var j="";return d&&!e?(d.message=i||d.message,void h(d)):(j=f+(a+b+".html").replace(g,""),void c.open("build/"+j,"w","0777",function(a,b){return a?(c.unlink("build/"+j,function(){}),void h(a)):void c.write(b,new Buffer(e),0,Buffer.byteLength(e),function(a){return c.close(b),a?(c.unlink("build/"+j,function(){}),void h(a)):void h(null,j)})}))})},d.showHtmlResults=function(f,g,h){d.saveHtmlResults(f,g,h,function(d,i){if(d)return void b.openModal("template/modal/error.html",!0,{title:"behat実行エラー",message:d.message});var j="?params="+encodeURIComponent(JSON.stringify({project:f,features:g,filepath:i,options:h})),k=e.Window.get(a.open("result-window.html"+j));k.on("closed",function(){k=null,c.unlink("build/"+i,function(){})}),e.Window.get().on("closed",function(){k&&c.unlink("build/"+i,function(){k.close()})})})},d.showSnippets=function(a,c){d.run(a,"-f snippets",c,function(a,c,d){return a&&!c?void b.openModal("template/modal/error.html",!0,{title:"behat実行エラー",message:d||a.message}):void(c.replace(/[\n|\r]/g,"")?h("<pre>"+c+"</pre>"):b.openModal("template/modal/error.html",!0,{title:"ステップ表示エラー",message:"未定義のステップはありませんでした"}))})},d}]),angular.module("winbehat").factory("codeMirrorService",function(){function a(a,d){for(var e=d&&d.word||n,f=a.getCursor(),g=a.getLine(f.line),h=f.ch,i=h,j=!1,k=[],l=b();i<g.length&&e.test(g.charAt(i));)++i;for(;h&&e.test(g.charAt(h-1));)--h;j=h!=i&&g.slice(h,i),j||(k=k.concat(m));for(var o=0,p=l.length;p>o;o++)j&&-1==l[o].indexOf(j,0)||k.push(l[o]);return{list:k.concat(c(a,d)),from:CodeMirror.Pos(f.line,h),to:CodeMirror.Pos(f.line,i)}}function b(){var a=[];for(var b in l)Array.prototype.push.apply(a,l[b]);return a.sort(function(a,b){return a>b?1:-1})}function c(a,b){for(var c=b&&b.word||/[\w$]+/,d=b&&b.range||500,e=a.getCursor(),f=a.getLine(e.line),g=e.ch,h=g,i=!1,j=[],k={},l=null;h<f.length&&c.test(f.charAt(h));)++h;for(;g&&c.test(f.charAt(g-1));)--g;i=g!=h&&f.slice(g,h),l=new RegExp(c.source,"g");for(var m=-1;1>=m;m+=2)for(var n=e.line,o=Math.min(Math.max(n+m*d,a.firstLine()),a.lastLine())+m;n!=o;n+=m)for(var p,q=a.getLine(n);p=l.exec(q);)(n!=e.line||p[0]!==i)&&(i&&0!=p[0].lastIndexOf(i,0)||Object.prototype.hasOwnProperty.call(k,p[0])||(k[p[0]]=!0,j.push(p[0])));return j}function d(a){return f.existsSync(a)?f.statSync(a).isDirectory()?void f.readdir(a,function(b,c){if(!b&&c.length)for(var e=0,f=c.length;f>e;e++)d(g.join(a,c[e]))}):void(/.*(Context\.php)$/.test(a)&&f.readFile(a,function(b,c){var d=c.toString().match(/@Give.*\/\^(.*)\$\//g);l[a]=d?d.map(function(a){return a.replace(/@Give.*\/\^(.*)\$\//,"$1")}):[]})):void 0}var e=require("./js/my-modules/filename-extension-list"),f=require("fs"),g=require("path"),h=CodeMirror.modes.gherkin();h.lineComment="#",CodeMirror.defineMode("gherkin",function(){return h});var i=function(a){var b=a.getOption("indentUnit"),c="",d=a.doc.sel,e=d.from,f=d.to,g=0,h=0,i=[],j={line:0,ch:0},k={line:0,ch:0};if(a.somethingSelected()){for(c=Array(b+1).join(" "),j.line=e.line,g=e.line,h=g+a.getSelection().split("\n").length-!f.ch;h>g;g++)i.push(c+a.doc.getLine(g)),k.line=g,k.ch=a.doc.getLine(g).length;a.doc.replaceRange(i.join("\n"),j,k),j.ch=e.ch+b,k.ch=f.ch+b,a.doc.setSelection(j,k)}else c=Array(b-e.ch%b+1).join(" "),a.replaceSelection(c,"end","+input")},j=function(a){CodeMirror.showHint(a,a.getHelper(a.getCursor(),"hint")||CodeMirror.hint.anyword)};CodeMirror.modeURL="js/lib/codemirror/mode/%N/%N.js";var k=function(a,b){CodeMirror.autoLoadMode(a,e[b]),a.setOption("mode",e[b])},l={},m="# language: ja,フィーチャ,シナリオ,前提,かつ,もし,ならば".split(",");CodeMirror.gherkinHint=a,CodeMirror.registerHelper("hint","gherkin",a);var n=/[\S]+/,o=null,p=function(a){l={},null!=o&&clearTimeout(o);var b=function(){d(a),o=setTimeout(b,3e4)};b()},q=CodeMirror.prototype.openDialog;return CodeMirror.defineExtension("openDialog",function(a,b,c){var d=q.call(this,a,b,c),e=function(){d(),CodeMirror.off(angular.element(".CodeMirror-scroll").get(0),"click",e)};return CodeMirror.off(angular.element(".CodeMirror-dialog input").get(0),"blur",d),CodeMirror.on(angular.element(".CodeMirror-scroll").get(0),"click",e),d}),{insertTab:i,autocomplete:j,changeMode:k,initBehatHint:p}}),angular.module("winbehat").factory("editFilelistService",function(){var a=require("fs"),b=require("path"),c=require("./js/my-modules/filename-extension-list"),d=[],e=function(e){for(var f=e.path(),g="",h=0,i=d.length;i>h;h++)if(d[h].file.path()===f)return h;return a.existsSync(f)?(g=e.readSync(),d.push({file:e,isSelected:!1,text:g,lastText:"",history:null,mode:c[b.extname(f).split(".").pop()],save:function(a){e.write(this.text,function(b){return b?void a(b):(this.lastText=this.text,void a())}.bind(this))},isChanged:function(){return this.text!=this.lastText}}),!0):new Error(f+" not found.")},f=function(a){return d.splice(a,1)[0]},g=function(a){var b=0,c=d.length;for(0>a?a=0:a>=c&&(a=c-1);c>b;b++)d[b].isSelected=!1;return d[a]&&(d[a].isSelected=!0),d[a]},h=function(a,b){d[a].path=b,d[a].name=b.split("\\").pop()},i=function(a){var b=0,c=0;for(b=0,c=d.length;c>b;b++)if(d[b].file.path()==a)return b;return-1};return{list:d,push:e,remove:f,select:g,rename:h,getId:i}}),angular.module("winbehat").factory("filelistService",function(){return require("./js/my-modules/filelist")}),angular.module("winbehat").factory("highlighService",function(){return{highlight:function(a){$(".highlight").removeClass("highlight"),$('pre[path="'+a.replace(/\\/g,"\\\\")+'"]').addClass("highlight")}}}),angular.module("winbehat").factory("modalService",["$modal",function(a){var b=function(b,c,d){return a.open({templateUrl:b,controller:function(a,b,c){a.params=c||{},a.init&&a.init(a),a.ok=c.ok||function(){b.close(c)},a.yes=c.yes||function(){b.close({selected:"ok",params:c})},a.no=c.no||function(){b.close({selected:"no",params:c})},a.cancel=c.cancel||function(){b.dismiss("cancel")}},backdrop:c||!1,resolve:{params:function(){return d}}})};return{openModal:b}}]);